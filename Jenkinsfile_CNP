#!groovy

@Library("Infrastructure")
import uk.gov.hmcts.contino.ProjectBranch

def type = "java"

def product = "adoption"
def component = "backend"

static Map<String, Object> secret(String secretName, String envVariable) {
  [ $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    envVariable: envVariable
  ]
}

withPipeline(type, product, component) {

  enableAksStagingDeployment()
  installCharts()
  enableSlackNotifications('#fpla_adoption_tech')

  env.PROXY_SERVER = "proxyout.reform.hmcts.net:8080"

  after('checkout') {
      onMaster {
        withCredentials([usernamePassword(credentialsId: 'jenkins-github-hmcts-api-token', usernameVariable: 'USERNAME', passwordVariable: 'BEARER_TOKEN')]) {
          try {
            sh '''
              set -e

              git remote set-url origin $(git config remote.origin.url | sed "s/github.com/${BEARER_TOKEN}@github.com/g")

              git fetch origin demo:demo
              git push --force origin HEAD:demo
            '''
          } catch (err) {
            notifyBuildEvent channel: '#fpla_adoption_tech', color: 'warning', message: 'Failed to update demo branch'
          }
        }
      }
    }

    before('smoketest:preview') {
        env.URL="https://adoption-backend-pr-${CHANGE_ID}.service.core-compute-preview.internal"
      }
}
